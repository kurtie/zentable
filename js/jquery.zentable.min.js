/**
    Zentable v1.0.4 Developed by Zentense (Apr'13)
    Copyright (c) 2009 Jose R. Cabanes
    Dual licensed under the MIT and GPL licenses.
    Needs jquery.timers, Draggable from jquery-ui and jquery.mousewheel
 */
 
(function(e){e.fn.zentable=function(t){var n=e.extend({},e.fn.zentable.defaults,t);if(t=="get")return e.fn.zentable.tables[this.get(0).id];if(t=="focus"){e.fn.zentable.focus.push(this.get(0).id);e.fn.zentable.resize();return}if(!e.fn.zentable.eventsHooked){e(document).keydown(e.fn.zentable.keyDown);e(window).resize(e.fn.zentable.resize);e.fn.zentable.eventsHooked=true}return this.each(function(){$this=e(this);e(this).empty();var t=new e.fn.zentable.Zentable(this.id,n);e.fn.zentable.tables[this.id]=t;e.fn.zentable.focus.push(this.id);if(n.onclick)t.onclick=n.onclick;if(n.onedit)t.editCallback=n.onedit;if(n.data instanceof Array){var r=new e.fn.zentable.ArrayDataSource(n.data);r.setCols(n.cols);t.setDataSource(r);t.dataLoaded()}else if(n.data!=undefined){var r=new e.fn.zentable.AJAXDataSource(n.data,t.getRows(),n.csvMaxDump);t.setDataSource(r);r.setFilters(n.filters);r.setOrder(n.order);for(i=0;i<n.filters.length;i++){var s=e("#"+n.filters[i]);if(s.length==0){s=e("input[name="+n.filters[i]+"]");if(s.length==0)s=e("select[name="+n.filters[i]+"]")}if(s.is("input[type=text]")){s.keyup(function(){e(this).oneTime(500,"filter",t.data.refresh)})}else if(s.is("input[type=text]")||s.is("input[type=checkbox]")||s.is("select"))s.change(function(){t.data.refresh()})}var o=t.getScroll();o.setCurrentRow(n.startRow);r.refresh()}})};e.fn.zentable.defaults={cols:[],data:undefined,hideIfEmpty:true,filters:[],onclick:false,onedit:false,order:"",rows:10,stylesInRows:false,totalsRow:false,csv:false,csvMaxDump:1e3,startRow:0};e.fn.zentable.tables={};e.fn.zentable.Focus=function(){var e=[];var t=0;this.get=function(){return e[t-1]};this.push=function(n){e[t++]=n};this.pop=function(){return e[--t]}};e.fn.zentable.focus=new e.fn.zentable.Focus;e.fn.zentable.keyDown=function(t){var n=e.fn.zentable.tables[e.fn.zentable.focus.get()];return n.keyDown(t)};e.fn.zentable.resize=function(){var t=e.fn.zentable.tables[e.fn.zentable.focus.get()];t.resizeColumns(true)};e.fn.zentable.eventsHooked=false;e.fn.zentable.focus[e.fn.zentable.focus.length]=null;e.fn.zentable.Zentable=function(t,n){function T(){a.find(".row .cell:not(.noteditable)").click(function(){S=e(this);S.parent().children().removeClass("hover");c.fadeTo(0,0);c.show();c.fadeTo(500,.4);f.css("top",S.position().top);f.css("left",S.position().left);var t=f.children().eq(0);t.width(S.width());t.get(0).value=S.html();f.fadeIn(250,function(){t.focus()})})}function N(){return a.width()-9*s-(d.data.getSize()>r?20:0)}function C(){var t=new Array;var n=Math.min(r,d.data.getSize());if(n==0){for(j=0;j<s;j++)t[j]=1}else{for(i=0;i<n;i++){var o=d.data.getRow(i);for(j=0;j<s;j++){var u=e("<span>"+o[j]+"</span>").text().length+5;if(t[j]==undefined||u>t[j])t[j]=u}}}d.setColumnWidths(t)}function k(){a=e("#"+t);a.height("auto");a.append('<div class="overlay"></div>');c=a.find(".overlay");a.append('<div class="tip"></div>');h=a.find(".tip");a.append('<div class="field"><input type="text"></div>');f=a.find(".field");a.append('<div id="'+t+'_scroll" class="scroll"></div>');l=new e.fn.zentable.Scrollbar(t,r,d);a.append('<div class="headerrow"></div>');row=a.find(".headerrow");a.append('<div class="rowcontainer"></div>');L();a.append('<div class="status"><div id="message"></div><div id="csv">CSV</div><div id="loading">LOADING...</div></div>');a.append('<div id="zt_csvwin_'+t+'" class="zt_csvwin"><div id="header">Zentable CSV<div id="close">X</div><div id="select">Select all</div></div><div id="csv"></div></div>');p=a.find(".status");d.setColumnWidths([1]);p.find("#csv").click(function(){e("#zt_csvwin_"+t).slideDown(1e3);d.data.dumpCSV(e("#zt_csvwin_"+t+" #csv"))});p.find("#csv").toggle(n.csv);e("#zt_csvwin_"+t+" #close").click(function(){e("#zt_csvwin_"+t).fadeOut(500)});e("#zt_csvwin_"+t+" #select").click(function(){if(window.getSelection){var n=window.getSelection();var r=document.createRange();r.selectNode(e("#zt_csvwin_"+t+" #csv").get(0));n.removeAllRanges();n.addRange(r)}else{document.selection.empty();var r=document.body.createTextRange();r.moveToElementText(e("#zt_csvwin_"+t+" #csv").get(0));r.select()}})}function L(){var u=a.find(".headerrow");u.empty();for(j=0;j<s;j++){if(o[j].hidden==undefined){u.append('<div class="header col'+j+(o[j].orderable?" orderable":"")+'">'+o[j].name+"</div>");if(j>0)u.append('<div id="'+t+"_"+j+'RS" ident="'+j+'" class="resize"></div>')}}a.find(".orderable").click(function(){for(j=0;j<s;j++)if(e(this).hasClass("col"+j))d.data.sort(j)});var f=a.find(".rowcontainer");f.empty();for(i=0;i<r;i++)f.append('<div class="row" row="'+i+'"></div>');if(n.totalsRow){f.append('<div class="totals"></div>');for(j=0;j<s;j++)a.find(".totals").append('<div class="col'+j+'"></div>')}f.find(".row").each(function(t){E[t]=new Array;for(j=0;j<s;j++){e(this).append('<div class="cell col'+j+" "+o[j].clss+(!o[j].editable?" noteditable":"")+(o[j].html?" html":"")+'"></div>');E[t][j]=e(this).find(".cell:last")}e(this).hover(function(){e(this).children().addClass("hover")},function(){e(this).children().removeClass("hover")})});a.find(".resize").draggable({axis:"x",drag:function(e,t){d.resizeColumn(e,t)},start:function(e,t){d.startResizeColumn(e,t)},stop:function(e,t){d.resizeColumns()}});a.find(".row .cell, .headerrow .header").hover(function(){d.hideTip();var t=e(this);if(!t.hasClass("html"))a.oneTime(1e3,"tip",function(){d.showTip(t)})},function(){a.stopTime("tip")});if(d.onclick)a.find(".row .noteditable").click(function(){for(x=0;x<s;x++)if(e(this).hasClass("col"+x))break;d.onclick(e(this),x,e(this).parent().attr("row")*1+l.getCurrentRow())});if(d.editCallback)T();for(j=0;j<s;j++){if(o[j].hidden!=undefined){o[j].width=-9;a.find(".col"+j).hide()}}}this.data=new e.fn.zentable.ArrayDataSource([]);var r=n.rows;var s=1;var o=[{name:"Empty"}];var u=new Array;var a,f,l,c,h,p;var d=this;var v=false;var m,g,b;var E=new Array;var S=null;this.setDataSource=function(e){o=null;this.data=e;e.setListener(this);l.setCurrentRow(0);if(n.hideIfEmpty&&e.isDataReady()&&e.getSize()==0)a.hide()};this.endEdit=function(){S=null;f.fadeOut(250);c.fadeOut(500)};this.setColumnWidths=function(e){u=e;totColWidth=0;tot=N();for(i=0;i<s;i++)if(o[i].width!=null)tot-=o[i].width;for(i=0;i<s;i++)if(o[i].width==null)totColWidth+=e[i];for(i=0;i<s;i++)u[i]=o[i].width!=null?o[i].width:u[i]*tot/totColWidth;this.resizeColumns()};this.refresh=function(){this.data.refresh();v=true};this.getRows=function(){return r};this.getTotalRows=function(){return l.getTotalRows()};this.dataLoaded=function(){a.show();var t=this.data.getSize();if(t>r)l.get().show();else{if(l.get().css("display")=="block"){l.get().hide();this.setColumnWidths(u)}else l.get().hide()}if(o==null){o=this.data.cols;s=o.length;L();a.find(".row").each(function(n){e(this).css("display",t>n?"block":"none")});C()}else{a.find(".row").each(function(n){e(this).css("display",t>n?"block":"none")})}l.setTotalRows(t);if(l.getCurrentRow()+r>t)l.move(t-l.getCurrentRow()-r);else l.refresh();if(n.hideIfEmpty){if(this.data.getSize()==0)a.hide();else a.show()}v=true};this.setLoading=function(e){var t=p.find("#loading");if(e)t.show();else t.fadeOut(250)};this.startResizeColumn=function(e,t){idx=t.helper.attr("ident")-1;while(o[idx].hidden!=undefined)idx--;g=a.find(".row .col"+idx).width();m=t.helper.offset().left};this.resizeColumn=function(e,t){idx=t.helper.attr("ident")-1;while(o[idx].hidden!=undefined)idx--;width=g+t.helper.offset().left-m;if(width<20)return;var n=0;for(i=idx+1;i<s;i++)n+=u[i];var r=N()-width;for(i=idx-1;i>=0;i--)r-=u[i];for(i=idx+1;i<s;i++){if(o[i].hidden==undefined&&u[i]/n*r<20)return}u[idx]=width;for(i=idx+1;i<s;i++)if(o[i].hidden==undefined)u[i]=parseInt(u[i]/n*r);this.resizeColumns()};this.resizeColumns=function(n){totalWidth=N();if(n){tmp=0;for(i=0;i<s;i++)tmp+=u[i]*1;for(i=0;i<s;i++)u[i]*=totalWidth/tmp}tmp=0;for(j=0;j<s-1;j++){w=parseInt(u[j]);a.find("* .col"+j).width(w);e("#"+t+"_"+j+"RS").css("left",tmp+9*j-4+"px");tmp+=w}e("#"+t+"_"+j+"RS").css("left",tmp+9*j-4+"px");a.find("* .col"+j).width(totalWidth-tmp-.5)};this.scrollChanged=function(){v=true};this.getScroll=function(){return l};this.scroller=function(){if(v){v=false;var t=l.getCurrentRow();for(i=0;i<r;i++){var o=d.data.getRow(i+t);for(j=0;j<s;j++)E[i][j].html(o?""+o[j]:"")}if(n.totalsRow){a.find(".totals div").each(function(t){e(this).html(d.data.totals[t])})}if(n.stylesInRows){a.find(".row").each(function(n){e(this).removeClass();e(this).addClass("row "+d.data.getRowClass(n+t))})}var u=l.getTotalRows();p.find("#message").html("Viewing "+(r>u?u:r)+" of "+u+" rows. Starting at row "+l.getCurrentRow())}};this.showTip=function(e){h.html(e.html());if(h.width()>e.width()*.9){h.css("top",e.position().top);h.css("left",e.position().left);h.fadeIn(250)}};this.hideTip=function(){h.fadeOut(400,function(){h.css("left",0)})};this.verticalResize=function(){var i=a.find(".row").height();r=parseInt((p.position().top-23-(n.totalsRow?i:0))/i);a.find(".scroll").empty();l=new e.fn.zentable.Scrollbar(t,r,d);l.setTotalRows(this.data.getSize());L();this.resizeColumns();v=true;p.css("top","");a.css("height","")};this.setOrderSign=function(e,t){a.find(".ascending,.descending").remove();var n=a.find(".headerrow .col"+e);n.append('<div class="'+(t?"ascending":"descending")+'"></div>')};k();a.find(".row:gt(0)").css("display","none");this.keyDown=function(e){if(S!=null){switch(e.keyCode){case 13:for(x=0;x<s;x++)if(S.hasClass("col"+x))break;y=S.parent().attr("row")*1;var t=f.children().eq(0).get(0).value;var n=o[x].id==null?o[x].name:o[x].id;d.editCallback(S,t,n,y+l.getCurrentRow());case 27:d.endEdit();break}return true}if(e.target!=undefined&&e.target.type!=undefined&&e.target.type.length>0)return true;switch(e.keyCode){case 38:l.up();break;case 40:l.down();break;case 33:l.pageUp();break;case 34:l.pageDown();break;case 36:l.first();break;case 35:l.last();break;default:return true}return false};e(document).ready(function(){a.mouseleave(function(){d.hideTip()});a.mousewheel(function(e,t){if(S!=null)return true;if(t>0)l.move(-5);else l.move(5);return false});a.everyTime(60,d.scroller);c.click(d.endEdit);p.draggable({axis:"y",grid:[0,21],drag:function(e,t){a.height(p.position().top+p.height())},stop:function(e,t){d.verticalResize()}})})};e.fn.zentable.Scrollbar=function(t,n,r){function f(){return i.height()-45}function l(){if(a<0)a=0;if(a>s-n)a=n>s?0:s-n}var i=e("#"+t+"_scroll");i.append('<div class="buttonup"></div>');i.append('<div class="drag_container"><div class="drag"></div></div>');i.append('<div class="buttondn"></div>');var s=0;var o=i.find(".drag");var u=this;var a=0;this.get=function(){return i};this.getCurrentRow=function(){return a};this.setCurrentRow=function(e){a=e};this.getTotalRows=function(){return s};this.setTotalRows=function(e){s=e;i.find(".drag_container").height(f());var t=f()*n/s;t=!isFinite(t)?f():t;o.height(t<25?25:t)};this.drag=function(e,t){var i=o.position().top;var u=parseInt((s-n)*i/(f()-o.height()-2));if(u!=a){a=u;r.scrollChanged(u)}};this.refresh=function(){l();o.css("top",parseInt((f()-o.height()-2)/(s-n)*a)+"px");r.scrollChanged(a)};this.down=function(){this.move(1)};this.up=function(){this.move(-1)};this.pageDown=function(){this.move(n)};this.pageUp=function(){this.move(-n)};this.first=function(){this.move(-a)};this.last=function(){this.move(s-n)};this.move=function(e){a+=e;this.refresh()};e(document).ready(function(){o.draggable({axis:"y",containment:"parent",drag:function(e,t){u.drag(e,t)}});o.click(function(){return false});i.find(".buttonup").click(function(){u.up()});i.find(".buttondn").click(function(){u.down()});i.find(".drag_container").click(function(e){var t=e.clientY-o.offset().top-22;if(t<o.position().top)u.pageUp();else u.pageDown();return false})})};e.fn.zentable.DataSource=function(e){this.cols=new Array;this.totals=new Array;this.setCols=function(e){this.cols=e};this.isDataReady=function(){return true};this.setListener=function(){};this.dumpCSV=function(t){t.empty();if(this.getSize()<1e3)e=this.getSize();for(i=0;i<e;i++){var n=this.getRow(i);for(j=0;n!=null&&j<n.length;j++)t.append((j>0?',"':'"')+n[j].replace('"','""')+'"');t.append("<br>")}}};e.fn.zentable.ArrayDataSource=function(t){this.base=e.fn.zentable.DataSource;this.base();this.getSize=function(){return t.length};this.getRow=function(e){return t[e]};this.set=function(e,n,r){t[e][n]=r}};e.fn.zentable.AJAXDataSource=function(t,n,r){t=t.indexOf("?")==-1?t+"?":t;this.base=e.fn.zentable.DataSource;this.base(r);var s="";var o=new Array;var u=new Array;var a=this;var f=0;var l=false;n==null?10:n;var c=[];var h=[];var p=false;var d=null;var v=null;this.refresh=function(){a.clearCache();a.loadPage(0)};this.setListener=function(e){d=e;d.setLoading(l)};this.setFilters=function(e){h=e};this.setOrder=function(e){s=e};this.clearCache=function(){o=new Array};this.isDataReady=function(){return p};this.processXML=function(t,n){var r=t.documentElement;f=e(t).find("totalrows").text();var i=e(t).find("offset").text();e(t).find("headers").find("col").each(function(t){a.cols[t]={name:e(this).text(),id:e(this).attr("id"),html:e(this).attr("html")!=null,width:e(this).attr("width"),editable:e(this).attr("editable")!="false",orderable:e(this).attr("orderable")!="false",clss:e(this).attr("class")==null?"":e(this).attr("class"),hidden:e(this).attr("hidden")}});e(t).find("row").each(function(t){o[i*1+t]={values:new Array,clss:e(this).attr("class")};e(this).find("col").each(function(n){var r=e(this);var s=a.cols[n].html?r.text():r.text().split("<").join("<").split(">").join(">");if(r.attr("link")!=null)s='<a href="'+r.attr("link")+'">'+s+"</a>";o[i*1+t].values[n]=s})});e(t).find("totals").find("col").each(function(t){a.totals[t]=e(this).text()});d.dataLoaded();l=false;d.setLoading(false);p=true;if(v!=null){this.dumpCSVParent(v);v=null}};this.sort=function(e){var t=this.cols[e].id==null?this.cols[e].name:this.cols[e].id;if(s==t)s=t+" desc";else s=t;d.setOrderSign(e,(new RegExp(" desc$")).test(s));o=new Array;this.loadPage(0)};this.getSize=function(){return f};this.getRow=function(e){if(e<f&&!o[e]&&!l)this.loadPage(e);if(o[e]==null)return null;return o[e].values};this.getRowClass=function(e){if(o[e]==null)return null;return o[e].clss};this.set=function(e,t,n){};this.loadPage=function(r){l=true;if(d!=null)d.setLoading(true);var o="";for(i=0;i<h.length;i++){var u=e("#"+h[i]);if(u.length==0){u=e("input[name="+h[i]+"]");if(u.length==0)u=e("select[name="+h[i]+"]")}var f="";if(u.is("input[type=checkbox]"))f=u.attr("checked")?u.attr("value"):"";else f=u.attr("value");o+="&"+h[i]+"="+f}var c=t+"&start="+r+"&pagesize="+n+"&order="+s+o;e.ajax({type:"GET",url:c,dataType:"xml",success:function(e,t){a.processXML(e)},error:function(e,t,n){alert("AJAX error: "+t+". "+n+" URL="+c)}})};this.dumpCSVParent=this.dumpCSV;this.dumpCSV=function(t){var i=n;n=r;this.dumpCSVParent(e(t));n=i;v=t}}})(jQuery)
